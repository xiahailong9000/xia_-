<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>C++服务器_udp</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type>
<META name=GENERATOR content="MSHTML 11.00.9600.18125"><LINK rel=stylesheet 
href="_template.css"></HEAD>
<BODY>
<DIV id=nsbanner>
<DIV id=bannerrow1>
<TABLE class=bannerparthead>
  <TBODY>
  <TR id=hdr>
    <TD class=runninghead noWrap>wwwwww</TD></TR></TBODY></TABLE></DIV>
<DIV id=titlerow>
<H1 class=dtH1>C++服务器_udp</H1></DIV></DIV>
<DIV id=nstext><BR>
<P><FONT size=3><FONT 
color=#ff0000>//服务端-------------------------------------------<BR></FONT>#include 
"stdio.h"<BR>#include 
"Winsock.h"<BR>//创建新的套接字之前需要调用一个引入Ws2_32.dll库的函数,否则服务器和客户端连接不上<BR>#pragma 
comment(lib,"ws2_32.lib") <BR>int main(int argc,char* argv[]) {<BR>&nbsp;WSADATA 
wsaData;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//指向WinSocket信息结构的指针<BR>&nbsp;SOCKET sockListener;<BR>&nbsp;SOCKADDR_IN 
x本机地址,x客户地址;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//设置两个地址，sin用来绑定<BR>&nbsp;//saClient用来从广播地址接收消息<BR>&nbsp;char 
cRecvBuff[800];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//定义接收缓冲区<BR>&nbsp;int nSize,nbSize;<BR>&nbsp;int 
iAddrLen=sizeof(x客户地址);<BR>&nbsp;if(WSAStartup(MAKEWORD(1,1),&amp;wsaData)!=0) 
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//进行WinSocket的初始化<BR>&nbsp;&nbsp;printf("Can't initiates windows socket!Program 
stop.\n");//初始化失败返回-1<BR>&nbsp;&nbsp;return 
-1;<BR>&nbsp;}<BR>&nbsp;sockListener=socket(AF_INET,SOCK_DGRAM,0);<BR>&nbsp;x本机地址.sin_family=AF_INET;<BR>&nbsp;x本机地址.sin_port=htons(5000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//发送端使用的发送端口，可以根据需要更改<BR>&nbsp;x本机地址.sin_addr.s_addr=htonl(INADDR_ANY);<BR>&nbsp;if(bind(sockListener,(SOCKADDR 
FAR *)&amp;x本机地址,sizeof(x本机地址))!=0) 
{//将套接字绑定到本机地址上----------------<BR>&nbsp;&nbsp;printf("绑定出错 
error:%d!\n",WSAGetLastError());<BR>&nbsp;&nbsp;return 
-1;<BR>&nbsp;}<BR>&nbsp;printf("udp:5000服务器正在监听---------------------------\n");<BR>&nbsp;while(1) 
{<BR>&nbsp;&nbsp;nSize=sizeof 
(SOCKADDR_IN);<BR>&nbsp;&nbsp;if((nbSize=recvfrom(sockListener,cRecvBuff,800,0,(SOCKADDR 
FAR *) &amp;x客户地址,&amp;nSize))==SOCKET_ERROR){ 
//若接收失败则提示错误<BR>&nbsp;&nbsp;&nbsp;printf("Recive 
Error");<BR>&nbsp;&nbsp;&nbsp;break;<BR>&nbsp;&nbsp;}<BR>&nbsp;&nbsp;cRecvBuff[nbSize]='\0';&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//字符串终止<BR>&nbsp;&nbsp;printf("%s\n",cRecvBuff);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//显示所接收到的字符串<BR>&nbsp;}<BR>&nbsp;return 0;<BR>}</FONT></P>
<P><FONT size=3></FONT>&nbsp;</P>
<P><FONT size=3></FONT>&nbsp;</P>
<P><BR><FONT color=#ff0000 
size=3>//客户端-----------------------------------------------------------------------------------------------</FONT><BR><FONT 
size=3>#include "stdio.h"<BR>#include "Winsock.h"<BR>#include 
&lt;string&gt;<BR>using namespace 
std;<BR>//创建新的套接字之前需要调用一个引入Ws2_32.dll库的函数,否则服务器和客户端连接不上<BR>#pragma 
comment(lib,"ws2_32.lib")<BR>struct test {<BR>&nbsp;string str;<BR>};<BR>struct 
UdpHeartPack {<BR>&nbsp;char UDPData[16] ;<BR>};<BR>int main(int argc,char* 
argv[]) {<BR>&nbsp;struct UdpHeartPack 
udpPack;<BR>&nbsp;udpPack.UDPData[0]='h';<BR>&nbsp;udpPack.UDPData[1]='e';<BR>&nbsp;udpPack.UDPData[2]='l';<BR>&nbsp;udpPack.UDPData[3]='l';<BR>&nbsp;udpPack.UDPData[4]='o';<BR>&nbsp;udpPack.UDPData[5]=' 
';<BR>&nbsp;udpPack.UDPData[6]='w';<BR>&nbsp;udpPack.UDPData[7]='o';<BR>&nbsp;udpPack.UDPData[8]='r';<BR>&nbsp;udpPack.UDPData[9]='l';<BR>&nbsp;udpPack.UDPData[10]='d';<BR>&nbsp;udpPack.UDPData[11]='\0';<BR>&nbsp;char 
*pPack=(char *)&amp;udpPack;<BR>&nbsp;WSADATA 
wsaData;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//指向WinSocket信息结构的指针<BR>&nbsp;SOCKET 
sockListener;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//创建套接字<BR>&nbsp;SOCKADDR_IN 
saUdpServ;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//指向通信对象的结构体指针&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
<BR>&nbsp;BOOL 
fBroadcast=TRUE;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//用于setsockopt(),表示允许<BR>&nbsp;char 
sendBuff[800];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//缓冲区存放发送的数据<BR>&nbsp;int 
ncount=0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//用于显示消息数目<BR>&nbsp;//*************************** 第一步初始化Winsock&nbsp;&nbsp; 
*****************************//<BR>&nbsp;if(WSAStartup(MAKEWORD(1,1),&amp;wsaData)!=0) 
{&nbsp;&nbsp;&nbsp;&nbsp; 
//进行WinSocket的初始化<BR>&nbsp;&nbsp;printf("WinSocket初始化失败返回-1.\n");//初始化失败返回-1<BR>&nbsp;&nbsp;return 
-1;<BR>&nbsp;}<BR>&nbsp;//********************&nbsp;&nbsp; 
第二步建立一个数据报类型的UDP套接字&nbsp; 
******************//<BR>&nbsp;sockListener=socket(PF_INET,SOCK_DGRAM,0);<BR>&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
setsockopt函数用于设置套接口选项<BR>&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
采用广播形式须将第三个参数设置为SO_BROADCAST<BR>&nbsp;setsockopt(sockListener,SOL_SOCKET,SO_BROADCAST,(CHAR 
*)&amp;fBroadcast,sizeof (BOOL));<BR>&nbsp;//&nbsp; 
参数设置，注意要将IP地址设为INADDR_BROADCAST，表示发送广播UDP数据报<BR>&nbsp;saUdpServ.sin_family=AF_INET;<BR>&nbsp;saUdpServ.sin_addr.s_addr=htonl(INADDR_BROADCAST);<BR>&nbsp;saUdpServ.sin_port=htons(5000);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//发送用的端口，可以根据需要更改</FONT></P>
<P><FONT size=3>&nbsp;while(1) 
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//循环发送数据<BR>&nbsp;&nbsp;Sleep(1000);<BR>&nbsp;&nbsp;sprintf_s(sendBuff,"Message 
%d is: ok",ncount++);&nbsp;&nbsp;&nbsp; 
//将ncount的值放入字符串senBuff中<BR>&nbsp;&nbsp;//**********************&nbsp; 
第三步使用sendto函数进行通信&nbsp;&nbsp;&nbsp; *************************// 
<BR>&nbsp;&nbsp;sendto(sockListener,/*sendBuff*/pPack,lstrlen(sendBuff)/*sizeof(udpPack)*/,0,(SOCKADDR 
*)&amp;saUdpServ,sizeof 
(SOCKADDR_IN));<BR>&nbsp;&nbsp;printf("%s\n",sendBuff);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//将要广播的数据串输出<BR>&nbsp;}<BR>&nbsp;//*********************&nbsp;&nbsp; 
第四步关闭socket&nbsp; 
***************************************//<BR>&nbsp;closesocket(sockListener);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
//关闭监听socket<BR>&nbsp;WSACleanup();<BR>&nbsp;return 
0;<BR>}</FONT></P></DIV></BODY></HTML>
